import { useState, useEffect, useRef } from "react"
import { ArrowLeft } from "lucide-react"
import { useNavigate } from "react-router-dom"
import { Button } from "../../components/signup/Button"
import { InputField } from "../../components/signup/InputField"
import { PasswordStep } from "./steps/PasswordStep"
import { PhoneStep } from "./steps/PhoneStep"
import { StoreInfoStep } from "./steps/StoreInfoStep"
import { SettlementInfoStep } from "./steps/SettlementInfoStep"
import { SignupCompleteStep } from "./steps/SignupCompleteStep"
import { OwnerApi } from "../../api/common/signup/OwnerApi"

type SignupStep = "email" | "password" | "phone" | "store" | "settlement" | "complete"

interface FormData {
  userId?: number
  name: string
  email: string
  emailVerificationCode: string
  password: string
  confirmPassword: string
  phone: string
  phoneVerificationCode: string
  storeName: string
  storeAddress: string
  storeAddressDetail: string
  storePhoto: string
  accountName: string
  accountHolder: string
  accountNumber: string
  taxEmail: string
  businessRegistrationNumber: string;
  storeDescription: string
  storePhone: string
  bankName: string
  businessLicenseFileUrl: string
}

const initialFormData: FormData = {
  userId: undefined,
  name: "",
  email: "",
  emailVerificationCode: "",
  password: "",
  confirmPassword: "",
  phone: "",
  phoneVerificationCode: "",
  storeName: "",
  storeAddress: "",
  storeAddressDetail: "",
  storePhoto: "",
  accountName: "",
  accountHolder: "",
  accountNumber: "",
  taxEmail: "",
  businessRegistrationNumber: "", 
  storeDescription: "",
  storePhone: "",
  bankName: "",
  businessLicenseFileUrl: "",
}

export default function OwnerSignupPage() {
  const navigate = useNavigate()
  const [currentStep, setCurrentStep] = useState<SignupStep>("email")
  const [formData, setFormData] = useState<FormData>(initialFormData)
  const [isEmailVerificationSent, setIsEmailVerificationSent] = useState(false)
  const [isEmailVerified, setIsEmailVerified] = useState(false)
  const [isPhoneVerificationSent, setIsPhoneVerificationSent] = useState(false)
  const [isPhoneVerified] = useState(false)

    // Î≤ÑÌäº variant ÏÉÅÌÉú Ï∂îÍ∞Ä
    const [buttonVariant, setButtonVariant] = useState<"primary" | "secondary">("primary")
    const [isConfirmButtonClicked, setIsConfirmButtonClicked] = useState(false)

  const mainRef = useRef<HTMLDivElement | null>(null)

  useEffect(() => {
    if ((currentStep === "store" || currentStep === "settlement") && mainRef.current) {
      console.log("Scrolling to top:", mainRef.current);
      setTimeout(() => {
        if (mainRef.current) {
          mainRef.current.scrollTo({ top: 0, behavior: "smooth" }); // ‚úÖ ÌôïÏã§ÌïòÍ≤å Ïä§ÌÅ¨Î°§ Ï†ÅÏö©
        }
      }, 0);
    }
  }, [currentStep]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }))
  }

  const handleEmailVerification = async () => {
    // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Î∞îÎ°ú Ïù∏Ï¶ù ÌïÑÎìúÎ•º ÌëúÏãú
    setIsEmailVerificationSent(true)
    setButtonVariant("secondary")
    try {
      await OwnerApi.sendEmailVerification(formData.email);
      // Ïù¥Î©îÏùº Ï†ÑÏÜ° ÏÑ±Í≥µ Ïãú Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω (ÌïÑÏöî Ïãú Ï∂îÍ∞Ä)
    } catch (error: any) {
      // Ïù¥Î©îÏùº Ï†ÑÏÜ° Ïã§Ìå® Ïãú Ïù∏Ï¶ù ÌïÑÎìúÎ•º Ïà®ÍπÄ
      setButtonVariant("primary")
      if (error.code === 3001) {
        alert('ÎÑàÎ¨¥ ÎßéÏùÄ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. ÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.');
      } else if (error.code === 1006) {
        alert('Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î©îÏùºÏûÖÎãàÎã§.');
        setIsEmailVerificationSent(false)
      } else {
        alert('Ïù∏Ï¶ùÎ≤àÌò∏ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
  }

  const handleEmailVerificationSubmit = async () => {
    try {
      await OwnerApi.verifyEmail(formData.email, formData.emailVerificationCode);
      setIsEmailVerified(true);
    } catch (error: any) {
      if (error.code === 3002) {
        alert('Ïù∏Ï¶ùÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§. Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
      } else if (error.code === 3004) {
        alert('Ïù¥ÎØ∏ ÏÇ¨Ïö©Îêú Ïù∏Ï¶ù ÏΩîÎìúÏûÖÎãàÎã§.');
      } else {
        alert('Ïù¥Î©îÏùº Ïù∏Ï¶ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    }
  }

  const handlePasswordSubmit = () => {
    setCurrentStep("phone")
  }

  const handlePhoneVerification = () => {
    // TODO: Implement phone verification logic
    console.log("Sending verification SMS to:", formData.phone)
    setIsPhoneVerificationSent(true)
  }

  const handlePhoneVerificationSubmit = async () => {
    if (formData.phone) {
      try {
        // ÌöåÏõêÍ∞ÄÏûÖ ÏßÑÌñâ
        const userResponse = await OwnerApi.register({
          name: formData.name,
          email: formData.email,
          password: formData.password,
          phone: formData.phone
        });
        
        // userIdÎ•º stateÏóê Ï†ÄÏû•
        setFormData(prev => ({
          ...prev,
          userId: userResponse.data.userId
        }));
        
        setCurrentStep("store");
      } catch (error: any) {
        if (error.code === 1006) {
          alert('Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ïù¥Î©îÏùºÏûÖÎãàÎã§.');
        } else if (error.code === 1008) {
          alert('Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Ï†ÑÌôîÎ≤àÌò∏ÏûÖÎãàÎã§.');
        } else {
          alert('ÌöåÏõêÍ∞ÄÏûÖÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
      }
    }
  };

  const handleStoreInfoSubmit = async () => {
    try {
      if (!formData.userId) {
        throw new Error('ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
      }

      const storeData = {
        userId: formData.userId,
        name: formData.storeName,
        description: formData.storeDescription,
        businessRegistrationNumber: formData.businessRegistrationNumber,
        addressRoad: formData.storeAddress,
        addressDetail: formData.storeAddressDetail,
        storePhoto: formData.storePhoto,
      };

 
      let bakeryImageUrl: File | undefined = undefined;
  
      if (formData.storePhoto && typeof formData.storePhoto === "string") {
        const res = await fetch(formData.storePhoto);
        const blob = await res.blob();
        bakeryImageUrl = new File([blob], 'store-photo.jpg', { type: blob.type });
      }
  
      console.log('Store data being sent to API:', storeData);  // APIÎ°ú Î≥¥ÎÇ¥Îäî Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
  
      const response = await OwnerApi.registerStore({
        ...storeData,
        bakeryImage: bakeryImageUrl,  // File Í∞ùÏ≤¥Î°ú Ï†ÑÎã¨
      });
  
      console.log('API response:', response);  // API ÏùëÎãµ ÌôïÏù∏
      setCurrentStep("settlement");
    } catch (error: any) {
      console.error('Store registration error details:', error.response?.data || error);
      throw error;  // ÏóêÎü¨Î•º Îã§Ïãú ÎçòÏ†∏ÏÑú ÏÉÅÏúÑÏóêÏÑú Ï≤òÎ¶¨
    }
  };

  const handleSettlementInfoSubmit = async () => {
    try {
      if (!formData.userId) {
        throw new Error("ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
      }
  
      // üîπ FormData Í∞ùÏ≤¥ ÏÉùÏÑ±
      const formDataToSend = new FormData();
  
      const settlementData = {
        userId: formData.userId,
        bankName: formData.bankName,
        accountHolderName: formData.accountHolder,
        accountNumber: formData.accountNumber,
        emailForTaxInvoice: formData.taxEmail,
      };
      console.log("üîπ Ï†ïÏÇ∞ Ï†ïÎ≥¥:", settlementData);
      console.log("image", formData.businessLicenseFileUrl)
  
      // üîπ JSON Îç∞Ïù¥ÌÑ∞Î•º BlobÏúºÎ°ú Î≥ÄÌôò ÌõÑ Ï∂îÍ∞Ä
      formDataToSend.append(
        "settlement",
        new Blob([JSON.stringify(settlementData)], { type: "application/json" })
      );
  
      // üîπ ÌååÏùºÏù¥ Î¨∏ÏûêÏó¥(URL)Ïù∏ Í≤ΩÏö∞ Î≥ÄÌôòÌïòÏó¨ Ï∂îÍ∞Ä
      if (formData.businessLicenseFileUrl) {
        if (typeof formData.businessLicenseFileUrl === "string") {
          const res = await fetch(formData.businessLicenseFileUrl);
          const blob = await res.blob();
          formDataToSend.append(  
          "businessLicenseFileUrl",
            new File([blob], `businessLicenseFile.${blob.type.split("/")[1] || "jpg"}`, { type: blob.type })
          );
        } else {
          // üîπ ÌååÏùº Í∞ùÏ≤¥Ïùº Í≤ΩÏö∞ Í∑∏ÎåÄÎ°ú Ï∂îÍ∞Ä
          formDataToSend.append("businessLicenseFile", formData.businessLicenseFileUrl);
        }
      }
  
      console.log("Settlement data being sent:", settlementData);
  
      // üîπ API Ìò∏Ï∂ú (FormDataÎ•º Í∑∏ÎåÄÎ°ú Ï†ÑÎã¨)
      const response = await OwnerApi.registerSettlement(formDataToSend);
      console.log("Settlement registration response:", response);
  
      setCurrentStep("complete");
    } catch (error: any) {
      console.error("Settlement registration error:", error.response?.data || error);
  
      if (error.response?.status === 500) {
        alert("ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
      } else {
        alert("Ï†ïÏÇ∞ Ï†ïÎ≥¥ Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏûÖÎ†•ÌïòÏã† Ï†ïÎ≥¥Î•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
      }
    }
  };
  
  
  const isEmailValid = formData.email.includes("@") && formData.email.includes(".")
  const isPasswordValid = formData.password.length >= 8
  const doPasswordsMatch = formData.password === formData.confirmPassword

  const handleBackClick = () => {
    switch (currentStep) {
      case "email":
        navigate("/signup")  // Ï≤´ Îã®Í≥ÑÏóêÏÑúÎäî ÌöåÏõêÍ∞ÄÏûÖ Ïú†Ìòï ÏÑ†ÌÉù ÌéòÏù¥ÏßÄÎ°ú
        break
      case "password":
        setCurrentStep("email")
        break
      case "phone":
        setCurrentStep("password")
        break
      case "store":
        setCurrentStep("phone")
        break
      case "settlement":
        setCurrentStep("store")
        break
      case "complete":
        setCurrentStep("settlement")
        break
    }
  }

  const handleNextClick = async () => {
    try {
      switch (currentStep) {
        case "email":
          setCurrentStep("password");
          break;
        case "password":
          handlePasswordSubmit();
          break;
        case "phone":
          await handlePhoneVerificationSubmit();
          break;
        case "store":
          await handleStoreInfoSubmit();
          break;
        case "settlement":
          await handleSettlementInfoSubmit();
          break;
      }
    } catch (error: any) {
      if (error.code === 2001) {
        alert(`'${formData.storeName}' ÏùÄ(Îäî) Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏù∏ Í∞ÄÍ≤å Ïù¥Î¶ÑÏûÖÎãàÎã§. Îã§Î•∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.`);
      } else if (error.code === 2000) {
        alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏÇ¨ÏóÖÏûê Îì±Î°ù Î≤àÌò∏ÏûÖÎãàÎã§. Îã§Î•∏ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      } else {
        alert(error.message || 'Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }
  };

  const renderStep = () => {
    switch (currentStep) {
      case "email":
        return (
          <div className="space-y-6">
            <h1 className="text-[22px] font-bold">Ïù¥Î©îÏùº ÏûÖÎ†•</h1>
            <p className="text-[15px] text-gray-600">ÏõêÌôúÌïú ÏÑúÎπÑÏä§ Ïù¥Ïö©ÏùÑ ÏúÑÌï¥ Ïù¥Î©îÏùº Ïù∏Ï¶ùÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî</p>
            <div className="space-y-6">
              <InputField label="Ïù¥Î¶Ñ" name="name" value={formData.name} onChange={handleChange} placeholder="ÌôçÍ∏∏Îèô" />
              <div className="space-y-2">
                <InputField
                  label="EMAIL"
                  name="email"
                  type="email"
                  value={formData.email}
                  onChange={handleChange}
                  placeholder="gildong123@gmail.com"
                  actionButton={
                    <Button
                      variant={buttonVariant}
                      fullWidth={false}
                      className="px-4 h-[38px] text-[14px] rounded-xl"
                      disabled={!isEmailValid || isEmailVerified}
                      onClick={handleEmailVerification}
                    >
                      {isEmailVerified ? "Ïù∏Ï¶ùÏôÑÎ£å" : "Ïù∏Ï¶ùÏöîÏ≤≠"}
                    </Button>
                  }
                />
                {isEmailVerificationSent && !isEmailVerified && (
                  <p className="text-sm text-[#FF9F43]">Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°Îêú Ïù∏Ï¶ù ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                )}
                {isEmailVerified && <p className="text-sm text-green-600">Ïù∏Ï¶ùÎêòÏóàÏäµÎãàÎã§!</p>}
              </div>
            </div>
            {isEmailVerificationSent && (
              <div className="mt-4">
                <InputField
                  label="Ïù∏Ï¶ùÎ≤àÌò∏"
                  name="emailVerificationCode"
                  value={formData.emailVerificationCode}
                  onChange={handleChange}
                  placeholder="Ïù∏Ï¶ùÎ≤àÌò∏ 6ÏûêÎ¶¨ ÏûÖÎ†•"
                  actionButton={
                    <Button
                      variant={isConfirmButtonClicked ? "secondary" : "primary"}
                      fullWidth={false}
                      className="px-4 h-[32px] text-sm rounded-xl"
                      onClick={() => {
                        handleEmailVerificationSubmit()
                        setIsConfirmButtonClicked(true)
                      }}
                      disabled={formData.emailVerificationCode.length !== 6}
                    >
                      ÌôïÏù∏
                    </Button>
                  }
                />
              </div>
            )}
          </div>
        )
      case "password":
        return (
          <div className="space-y-6">
            <h1 className="text-[22px] font-bold">ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</h1>
            <p className="text-[15px] text-gray-600">ÏïàÏ†ÑÌïú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</p>
            <PasswordStep formData={formData} onChange={handleChange} />
          </div>
        )
      case "phone":
        return (
          <div className="pt-8">
            <h1 className="text-[22px] font-bold mb-2">Ï†ÑÌôîÎ≤àÌò∏ ÏûÖÎ†•</h1>
            <p className="text-[15px] text-gray-600 mb-8">ÏõêÌôúÌïú ÏÑúÎπÑÏä§ Ïù¥Ïö©ÏùÑ ÏúÑÌï¥ Ï†ÑÌôîÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî</p>
            <PhoneStep
              formData={{
                phone: formData.phone,
                verificationCode: formData.phoneVerificationCode,
              }}
              onChange={handleChange}
              onPhoneVerification={handlePhoneVerification}
              onVerificationSubmit={handlePhoneVerificationSubmit}
              isVerificationSent={isPhoneVerificationSent}
              isVerified={isPhoneVerified}
            />
          </div>
        )
      case "store":
        return (
          <div className="max-h-[calc(100vh-180px)] overflow-y-auto
              [&::-webkit-scrollbar]:w-2
              [&::-webkit-scrollbar-track]:rounded-full
              [&::-webkit-scrollbar-track]:bg-gray-100
              [&::-webkit-scrollbar-thumb]:rounded-full
              [&::-webkit-scrollbar-thumb]:bg-gray-300
              dark:[&::-webkit-scrollbar-track]:bg-neutral-700
              dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500">
            <div className="mr-2">
              <h1 className="text-[22px] font-bold">Í∞ÄÍ≤å Ï†ïÎ≥¥</h1>
              <p className="text-[15px] text-gray-600 mb-4">ÏûÖÎ†•ÌïòÏã† ÎÇ¥Ïö©ÏùÄ Ïñ∏Ï†úÎì†ÏßÄ Î≥ÄÍ≤Ω Í∞ÄÎä•Ìï¥Ïöî.</p>
              <StoreInfoStep formData={formData} onChange={handleChange} />
            </div>
          </div>
        )
      case "settlement":
        return (
          <div className="max-h-[calc(100vh-180px)] overflow-y-auto
              [&::-webkit-scrollbar]:w-2
              [&::-webkit-scrollbar-track]:rounded-full
              [&::-webkit-scrollbar-track]:bg-gray-100
              [&::-webkit-scrollbar-thumb]:rounded-full
              [&::-webkit-scrollbar-thumb]:bg-gray-300
              dark:[&::-webkit-scrollbar-track]:bg-neutral-700
              dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500">
            <div className="mr-2">
              <h1 className="text-[22px] font-bold">Ï†ïÏÇ∞ Ï†ïÎ≥¥</h1>
              <p className="text-[15px] text-gray-600 mb-4">Î™®Îì† Ìï≠Î™©Ïù¥ ÏûÖÎ†•ÎêòÏñ¥Ïïº, Ï†ïÏÇ∞Í∏àÏù¥ Ïù¥Ï≤¥Îê©ÎãàÎã§.</p>
              <SettlementInfoStep
                formData={{
                  bankName: formData.bankName,
                  accountHolder: formData.accountHolder,
                  accountNumber: formData.accountNumber,
                  taxEmail: formData.taxEmail,
                  businessRegistration: formData.businessRegistrationNumber,
                }}
                onChange={handleChange}
                onSubmit={handleSettlementInfoSubmit}
              />
            </div>
          </div>
        )
      case "complete":
        return <SignupCompleteStep isOwner={true} email={formData.email} password={formData.password} />
    }
  }

  return (
    <div className="w-full max-w-[430px] mx-auto min-h-screen bg-white flex flex-col">
      {/* Header */}
      <header className="fixed top-0 left-0 right-0 z-10 h-[52px] flex items-center border-b border-gray-100 bg-white max-w-[430px] mx-auto">
        <button onClick={handleBackClick} className="p-3 text-gray-800">
          <ArrowLeft className="w-6 h-6" />
        </button>
      </header>

      {/* Content */}
      <main ref={mainRef} className="flex-1 overflow-y-auto h-[calc(100vh-52px)] pt-[52px] pb-[80px] px-5">
        <div className="py-6">{renderStep()}</div>
      </main>

      {/* Bottom Button */}
      {currentStep !== "complete" && (
        <div className="fixed bottom-0 left-0 right-0 px-5 py-4 bg-white border-t border-gray-100 max-w-[430px] mx-auto">
          <Button
            onClick={handleNextClick}
            disabled={
              currentStep === "email"
                ? !isEmailVerified || !formData.name || !isEmailValid
                : currentStep === "password"
                  ? !isPasswordValid || !doPasswordsMatch
                  : currentStep === "phone"
                    ? !formData.phone
                    : currentStep === "store"
                      ? !formData.storeName || !formData.storeAddress || !formData.storePhoto
                      : !formData.bankName || !formData.accountHolder || !formData.accountNumber
            }
          >
            {currentStep === "settlement" ? "Í∞ÄÏûÖ ÏôÑÎ£å" : "Îã§Ïùå"}
          </Button>
        </div>
      )}
    </div>
  )
}

